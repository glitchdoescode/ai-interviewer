# 10-1 Organization and Multi-Tenant Data Model

[Back to task list](./tasks.md)

## Description

This task involves designing and implementing the data models needed to support a multi-tenant architecture with organizations, job postings, and related entities. These models will form the foundation for the ATS integration and multi-user functionality, allowing the system to properly isolate data between organizations while maintaining relationships between users, job postings, and candidates.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2023-07-25 10:00:00 | Created | N/A | Proposed | Task file created | User |

## Requirements

1. The system must support multiple organizations (tenants) with complete data isolation
2. Each organization must be able to have multiple users with different roles
3. Job postings must be associated with specific organizations
4. The data model must support linking to external ATS identifiers
5. All entities must have proper audit fields (created_at, updated_at, created_by, etc.)
6. The database schema must enforce referential integrity where appropriate
7. The models must be extensible to accommodate future ATS integrations

## Implementation Plan

### Phase 1: Data Model Design and Database Schema (1-2 days)

1. **Design Organization Model**
   - Create `Organization` entity with fields:
     - id (UUID)
     - name
     - slug (URL-friendly identifier)
     - description
     - contact_email
     - logo_url
     - settings (JSON for organization-specific settings)
     - external_ids (JSON for ATS identifiers)
     - created_at
     - updated_at
     - is_active

2. **Enhance User Model**
   - Modify existing `User` model to include:
     - organization_id (foreign key to Organization)
     - Update `UserRole` enum to include new roles:
       - EMPLOYER_ADMIN
       - EMPLOYER_RECRUITER
       - EMPLOYER_INTERVIEWER
     - Allow users to be associated with a specific organization

3. **Create Job Posting Model**
   - Create `JobPosting` entity with fields:
     - id (UUID)
     - organization_id (foreign key to Organization)
     - title
     - description
     - required_skills (array)
     - seniority_level
     - department
     - location
     - remote_status
     - external_id (from ATS)
     - external_url
     - status (open, closed, draft)
     - created_at
     - updated_at
     - created_by (user_id)
     - metadata (JSON for additional fields)

4. **Create Interview Template Model**
   - Create `InterviewTemplate` entity with fields:
     - id (UUID)
     - organization_id (foreign key to Organization)
     - job_posting_id (foreign key to JobPosting, optional)
     - name
     - description
     - is_approved
     - approved_by (user_id)
     - approved_at
     - created_at
     - updated_at
     - created_by (user_id)
     - settings (JSON for template settings)

5. **Database Schema Design**
   - Create proper indexes for performance
   - Define foreign key constraints
   - Plan for database migrations

### Phase 2: Database Migration and Model Implementation (1-2 days)

1. **Create MongoDB Migration Scripts**
   - Write migration scripts to create new collections
   - Ensure backward compatibility with existing data

2. **Implement Pydantic Models**
   - Create Python models for all entities
   - Implement validation logic
   - Create appropriate model relationships

3. **Repository Layer Implementation**
   - Create data access functions for each model
   - Implement CRUD operations
   - Add organization-based filtering to all queries

### Phase 3: API and Service Layer (1-2 days)

1. **Service Layer Implementation**
   - Create services for managing organizations
   - Implement user-organization association logic
   - Create job posting management services

2. **API Endpoint Implementation**
   - Create REST endpoints for organization management
   - Create endpoints for job posting management
   - Update existing endpoints to respect organization boundaries

3. **Organization Context Middleware**
   - Implement request middleware to establish organization context
   - Ensure all operations are scoped to the user's organization

## Verification

### Unit Tests
1. Test organization CRUD operations
2. Test user-organization associations
3. Test job posting CRUD operations
4. Test relationship integrity between models

### Integration Tests
1. Test organization context in API requests
2. Test data isolation between organizations
3. Test organization-scoped queries

### Acceptance Criteria
1. Organizations can be created, updated, and managed
2. Users can be associated with organizations
3. Job postings can be created and associated with organizations
4. All data is properly isolated between organizations
5. Database performance is not significantly impacted by multi-tenant design

## Files Modified

### New Files
- `ai_interviewer/models/organization.py`
- `ai_interviewer/models/job_posting.py` 
- `ai_interviewer/models/interview_template.py`
- `ai_interviewer/services/organization_service.py`
- `ai_interviewer/services/job_posting_service.py`
- `ai_interviewer/routers/organization.py`
- `ai_interviewer/routers/job_posting.py`
- `ai_interviewer/core/organization_context.py`

### Modified Files
- `ai_interviewer/models/user_models.py` (Update UserRole enum and add organization relationship)
- `ai_interviewer/auth/services.py` (Update to handle organization context)
- `ai_interviewer/auth/security.py` (Update to include organization in token)
- `ai_interviewer/core/database.py` (Update to support organization filtering) 