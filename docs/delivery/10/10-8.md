# 10-8 Email Notification Service

[Back to task list](./tasks.md)

## Description

This task involves creating a robust email notification service that will handle sending interview invitations and reminders to candidates. The service will support customizable email templates, delivery tracking, and scheduled sending. This is a critical component for enabling automated candidate invitations from ATS shortlists.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2023-07-25 10:00:00 | Created | N/A | Proposed | Task file created | User |

## Requirements

1. Create a service that can send emails with customizable templates
2. Support organization-specific branding in email templates
3. Track email delivery, opens, and clicks
4. Enable scheduled sending of emails
5. Store records of all sent communications
6. Support personalization with candidate and job data
7. Include secure authentication tokens in emails
8. Implement retry logic for failed deliveries
9. Comply with email regulations including unsubscribe options

## Implementation Plan

### Phase 1: Email Service Integration (1-2 days)

1. **Research and Select Email Service Provider**
   - Evaluate options: SendGrid, Mailgun, AWS SES
   - Consider features, pricing, and API compatibility
   - Document decision and rationale

2. **Create Email Service Abstraction**
   - Design interface for email operations
   - Implement provider-specific adapter
   - Configure environment variables for API keys and settings

3. **Basic Email Sending**
   - Implement plain text and HTML email sending
   - Add support for attachments
   - Create error handling and logging

### Phase 2: Email Template System (1-2 days)

1. **Template Data Model**
   - Create `EmailTemplate` entity with fields:
     - id (UUID)
     - organization_id (foreign key to Organization)
     - name
     - description
     - subject_template
     - text_body_template
     - html_body_template
     - created_at
     - updated_at
     - created_by (user_id)
     - is_default
     - template_type (invitation, reminder, etc.)

2. **Template Rendering Engine**
   - Implement Jinja2-based template rendering
   - Create context objects for different email types
   - Add support for organization-specific variables
   - Implement default fallback templates

3. **Template Management API**
   - Create CRUD endpoints for templates
   - Add template preview functionality
   - Implement template validation

### Phase 3: Notification Management (1-2 days)

1. **Notification Record Model**
   - Create `EmailNotification` entity with fields:
     - id (UUID)
     - organization_id (foreign key to Organization)
     - recipient_email
     - recipient_name
     - subject
     - template_id (foreign key to EmailTemplate)
     - status (queued, sent, delivered, opened, clicked, failed)
     - sent_at
     - delivered_at
     - opened_at
     - clicked_at
     - error_message
     - retry_count
     - metadata (JSON for additional data)
     - related_entity_type (candidate, job, etc.)
     - related_entity_id

2. **Notification Tracking**
   - Implement webhooks for delivery events
   - Create tracking pixel for open tracking
   - Set up link rewriting for click tracking
   - Store tracking data in notification records

3. **Scheduled Sending**
   - Create scheduling infrastructure
   - Implement notification queue
   - Add support for canceling scheduled emails

### Phase 4: Interview Invitation Functionality (1-2 days)

1. **Invitation Service**
   - Create service for sending interview invitations
   - Implement candidate data merging
   - Generate secure interview tokens
   - Add job posting data to email context

2. **Default Invitation Templates**
   - Create standard invitation templates
   - Design mobile-friendly HTML email layout
   - Include clear call-to-action buttons

3. **Bulk Invitation Support**
   - Implement batch processing for multiple invitations
   - Add rate limiting to prevent sending too many at once
   - Create status reporting for bulk operations

## Verification

### Unit Tests
1. Test email service abstraction
2. Test template rendering
3. Test notification record creation
4. Test tracking data processing

### Integration Tests
1. Test end-to-end email delivery
2. Test tracking webhooks
3. Test scheduled sending
4. Test organization-specific templates

### Acceptance Criteria
1. System can send branded email invitations to candidates
2. Templates can be customized by organization
3. All emails include secure authentication tokens
4. Email delivery and engagement is tracked
5. Failed emails are automatically retried
6. Bulk invitations can be processed efficiently

## Files Modified

### New Files
- `ai_interviewer/models/email_template.py`
- `ai_interviewer/models/email_notification.py`
- `ai_interviewer/services/email_service.py`
- `ai_interviewer/services/notification_service.py`
- `ai_interviewer/services/invitation_service.py`
- `ai_interviewer/routers/email_templates.py`
- `ai_interviewer/routers/notifications.py`
- `ai_interviewer/core/email_providers/base.py`
- `ai_interviewer/core/email_providers/sendgrid.py` (or other provider)
- `ai_interviewer/core/template_engine.py`

### Modified Files
- `ai_interviewer/server.py` (Add routes and dependencies)
- `ai_interviewer/core/config.py` (Add email service settings)
- `requirements.txt` (Add email provider SDK and Jinja2) 