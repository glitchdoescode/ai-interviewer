# 8-2 Develop LangGraph Context Injection Service

[Back to task list](./tasks.md)

## Description

Create a service that bridges the existing LangGraph interview logic with the Gemini Live API by injecting interview context, stage transitions, and tool call results silently into the real-time conversation stream.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-01-27 10:45:00 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2025-01-27 15:40:00 | Status Change | Proposed | Agreed | Task approved for implementation | User |
| 2025-01-27 15:45:00 | Status Change | Agreed | InProgress | Started implementation of Context Injection Service | AI_Agent |
| 2025-01-27 16:00:00 | Status Change | InProgress | Review | Implementation completed, ready for review | AI_Agent |
| 2025-01-27 16:05:00 | Status Change | Review | Done | Implementation approved and completed | User |

## Requirements

### Functional Requirements
1. **Context Formatting**
   - Convert existing INTERVIEW_SYSTEM_PROMPT to real-time context updates
   - Format job_role, seniority_level, required_skills, job_description for injection
   - Handle interview stage transitions as context updates

2. **Silent Injection**
   - Inject context without triggering AI responses
   - Batch context updates to minimize API calls
   - Preserve conversation flow during context injection

3. **LangGraph Integration**
   - Monitor existing interview state from InterviewState objects
   - Translate tool call results into context updates
   - Handle conversation summaries and memory management

### Technical Requirements
1. **Dependencies**: Integration with existing AIInterviewer class
2. **Format**: Use geminicode1.py silent context injection pattern
3. **Performance**: Context updates should not exceed 100ms processing time
4. **Memory**: Maintain context history for conversation continuity

## Implementation Plan

### Phase 1: Context Formatter
```python
# File: ai_interviewer/services/context_injection_service.py

class ContextInjectionService:
    def __init__(self, gemini_adapter: GeminiLiveAudioAdapter):
        self.gemini_adapter = gemini_adapter
        self.current_context = {}
        self.context_history = []
        
    def format_interview_context(self, interview_state: InterviewState) -> str:
        """Convert InterviewState to silent context string"""
        
    async def inject_stage_transition(self, 
                                    from_stage: str, 
                                    to_stage: str, 
                                    context: Dict[str, Any]):
        """Inject interview stage transition as silent context"""
        
    async def inject_tool_result(self, tool_name: str, tool_result: Dict[str, Any]):
        """Inject LangGraph tool results as context"""
        
    async def update_session_context(self, session_metadata: Dict[str, Any]):
        """Update ongoing session context (candidate name, job details, etc.)"""
```

### Phase 2: Interview State Monitoring
- Monitor InterviewState changes from existing LangGraph workflow
- Detect stage transitions and trigger context updates
- Handle tool call results and inject them as conversation context

### Phase 3: Context Batching and Optimization
- Implement context batching to reduce API calls
- Add context deduplication to avoid redundant updates
- Optimize context string formatting for token efficiency

## Verification

### Unit Tests
1. **Context Formatting**
   - Test InterviewState to context string conversion
   - Verify all required fields are included
   - Test context string length optimization

2. **Silent Injection**
   - Test context injection without response triggering
   - Verify context batching functionality
   - Test context deduplication

3. **Integration with LangGraph**
   - Test stage transition detection
   - Verify tool result injection
   - Test session metadata updates

### Integration Tests
1. **End-to-End Context Flow**
   - Test complete interview with context injection
   - Verify context persistence across stage transitions
   - Test context injection during active conversation

2. **Performance Testing**
   - Test context injection latency (<100ms)
   - Verify no impact on audio streaming performance
   - Test memory usage during long interviews

## Files Modified

- `ai_interviewer/services/context_injection_service.py` (new)
- `ai_interviewer/core/ai_interviewer.py` (modified - add context injection hooks)
- `ai_interviewer/services/__init__.py` (updated)
- `tests/unit/services/test_context_injection_service.py` (new)
- `tests/integration/test_langgraph_context_bridge.py` (new)

## Test Plan

### Context Injection Scenarios
1. **Interview Start**: Initial context injection with job details
2. **Stage Transitions**: Context updates during stage changes
3. **Tool Results**: Coding challenge results injection
4. **Session Resume**: Context restoration from MongoDB

### Success Criteria
- Context injection completes within 100ms
- No audio interruption during context updates
- All interview stages work with injected context
- Context persistence across session reconnections
- Memory usage remains stable during context injection 