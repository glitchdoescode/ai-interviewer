# 7-4 Screen Activity Monitoring

[Back to task list](./tasks.md)

## Description

Develop browser event monitoring for tab switches, copy-paste, and window focus to detect potential cheating behaviors during AI interviews. This task implements comprehensive screen activity tracking using browser APIs to monitor candidate behavior and log suspicious activities in real-time.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-01-10 14:30:00 | Status Change | Proposed | Agreed | Task approved by User | User |
| 2025-01-10 14:30:00 | Status Change | Agreed | InProgress | Started implementation | AI_Agent |
| 2025-01-31 21:55:00 | Status Change | InProgress | Review | Implementation completed - screen activity monitoring fully functional with comprehensive test coverage | AI_Agent |
| 2025-06-02 22:25:00 | Status Change | Review | Done | Fixed MediaPipe compilation issues, resolved WebSocket message format warnings, all 31 tests passing. Screen activity monitoring fully operational. | AI_Agent |
| 2025-06-02 22:51:00 | Status Change | Review | Done | Task approved by User - all screen activity monitoring features working: tab switch detection, copy-paste monitoring, window focus tracking, WebSocket integration, 31 tests passing | User |

## Requirements

### Functional Requirements
1. **Tab Switch Detection**
   - Monitor `visibilitychange` events to detect when candidate switches tabs
   - Track exact timestamps of tab switches and duration away from interview tab
   - Differentiate between intentional navigation and accidental tab switches
   - Log tab switch frequency and patterns for anomaly detection

2. **Copy-Paste Activity Monitoring**
   - Detect and log all copy (`Ctrl+C`) and paste (`Ctrl+V`) operations
   - Monitor clipboard API usage if permissions allow
   - Track content length and frequency of copy-paste actions
   - Identify external paste operations (content not from current session)

3. **Window Focus Monitoring**
   - Track window focus and blur events
   - Detect when candidate switches between applications
   - Monitor new window/application openings
   - Log time spent away from the interview application

4. **Keyboard Shortcut Detection**
   - Monitor suspicious keyboard combinations (Alt+Tab, Ctrl+Shift+T, etc.)
   - Detect browser console access attempts (F12, Ctrl+Shift+I)
   - Track navigation shortcuts (Ctrl+T for new tab, Ctrl+W for close tab)
   - Log screenshot attempts (Print Screen, Windows+Shift+S)

5. **Real-time Logging and Alerts**
   - Send activity data to backend via WebSocket in real-time
   - Generate immediate alerts for suspicious patterns
   - Maintain local activity buffer for connection resilience
   - Implement threshold-based anomaly detection

### Technical Requirements
1. **Browser API Integration**
   - Use Document API for visibility change events
   - Implement Window API for focus/blur detection
   - Utilize Keyboard API for key combination monitoring
   - Integrate Clipboard API where supported and permitted

2. **Cross-Browser Compatibility**
   - Support Chrome, Firefox, Safari, and Edge
   - Handle API differences gracefully
   - Provide fallback mechanisms for unsupported features
   - Test on mobile browsers for responsive support

3. **Performance Optimization**
   - Minimize event listener overhead
   - Implement efficient event batching for WebSocket transmission
   - Use throttling for high-frequency events
   - Optimize memory usage for long interview sessions

4. **Privacy and Security**
   - Request minimal necessary permissions
   - Avoid accessing actual clipboard content
   - Implement secure event data transmission
   - Provide clear user notifications about monitoring

### Integration Requirements
1. **Frontend Integration**
   - Seamlessly integrate with existing React interview components
   - Coordinate with webcam monitoring system
   - Maintain compatibility with voice recording features
   - Work alongside coding challenge interfaces

2. **Backend Communication**
   - Extend existing WebSocket connection for activity data
   - Integrate with proctoring session management
   - Store activity logs in MongoDB with proper indexing
   - Support real-time alert generation

3. **Configuration Management**
   - Allow admin configuration of monitoring sensitivity
   - Support role-based monitoring levels
   - Enable selective feature toggling
   - Provide customizable alert thresholds

## Implementation Plan

### Phase 1: Core Activity Detection (2-3 days)
1. **Set up monitoring infrastructure**
   - Create `ScreenActivityMonitor` React component
   - Implement base event listener management
   - Set up activity data structures and types
   - Create unit tests for core functionality

2. **Implement tab switch detection**
   - Add `visibilitychange` event listeners
   - Track tab visibility state changes
   - Calculate time away from interview tab
   - Test across different browsers

3. **Add window focus monitoring**
   - Implement `focus` and `blur` event handlers
   - Track application switching behavior
   - Monitor new window creation attempts
   - Handle edge cases (minimized windows, notifications)

### Phase 2: Advanced Monitoring Features (2-3 days)
1. **Implement copy-paste detection**
   - Add keyboard event listeners for Ctrl+C/V
   - Monitor clipboard API interactions
   - Track paste frequency and patterns
   - Handle permission requests gracefully

2. **Add keyboard shortcut monitoring**
   - Detect browser console access attempts
   - Monitor tab management shortcuts
   - Track screenshot key combinations
   - Implement suspicious key pattern recognition

3. **Enhance cross-browser support**
   - Test on all major browsers
   - Implement browser-specific workarounds
   - Add feature detection for API availability
   - Create fallback mechanisms

### Phase 3: Integration and Optimization (2-3 days)
1. **WebSocket integration**
   - Extend existing proctoring WebSocket for activity data
   - Implement activity event batching
   - Add connection resilience for offline scenarios
   - Test real-time data transmission

2. **Backend integration**
   - Update proctoring models for activity data storage
   - Implement activity log endpoints
   - Add real-time anomaly detection rules
   - Create activity summary reports

3. **Performance optimization**
   - Implement event throttling and debouncing
   - Optimize memory usage for long sessions
   - Add performance monitoring
   - Conduct load testing

### Phase 4: Testing and Documentation (1-2 days)
1. **Comprehensive testing**
   - Unit tests for all monitoring functions
   - Integration tests with existing proctoring system
   - Cross-browser compatibility testing
   - Performance and memory leak testing

2. **Documentation and configuration**
   - Update API documentation
   - Create admin configuration guides
   - Document privacy implications
   - Add troubleshooting guides

## Verification

### Test Plan

#### Unit Tests
1. **Event Detection Tests**
   - Verify tab switch events are correctly captured
   - Test copy-paste key combination detection
   - Validate window focus/blur event handling
   - Confirm keyboard shortcut recognition

2. **Cross-Browser Tests**
   - Test event detection on Chrome, Firefox, Safari, Edge
   - Verify API fallbacks work correctly
   - Test mobile browser compatibility
   - Confirm graceful degradation for unsupported features

3. **Performance Tests**
   - Measure event listener overhead
   - Test memory usage during long sessions
   - Verify event batching efficiency
   - Check WebSocket transmission performance

#### Integration Tests
1. **Proctoring System Integration**
   - Test coordination with webcam monitoring
   - Verify WebSocket data transmission
   - Test backend activity log storage
   - Confirm real-time alert generation

2. **Interview Flow Integration**
   - Test compatibility with voice interviews
   - Verify coding challenge integration
   - Test session state consistency
   - Confirm user experience preservation

#### End-to-End Tests
1. **Full Monitoring Session**
   - Conduct complete interview with all monitoring active
   - Verify all activity types are detected and logged
   - Test anomaly detection and alert generation
   - Confirm proctoring report includes activity data

2. **Edge Case Scenarios**
   - Test behavior during network disconnections
   - Verify handling of permission denials
   - Test with multiple monitors and windows
   - Confirm behavior during system resource constraints

### Success Criteria
1. **Functionality**
   - All specified activity types are detected with >95% accuracy
   - Cross-browser compatibility across Chrome, Firefox, Safari, Edge
   - Real-time data transmission with <200ms latency
   - No false positives for normal interview behavior

2. **Performance**
   - Event monitoring adds <5% CPU overhead
   - Memory usage remains stable during 2+ hour sessions
   - WebSocket transmission handles 100+ events per minute
   - No impact on interview user experience

3. **Integration**
   - Seamless coordination with existing proctoring features
   - Compatible with all interview types (voice, coding, Q&A)
   - Consistent session state management
   - Proper data storage and retrieval

4. **Privacy and Security**
   - All monitoring activities clearly disclosed to users
   - Minimal permission requests (only what's necessary)
   - Secure data transmission and storage
   - GDPR-compliant activity logging

## Files Modified

### New Files
- `frontend/src/components/proctoring/ScreenActivityMonitor.jsx` - Main monitoring component
- `frontend/src/hooks/useScreenActivity.js` - Activity monitoring hook
- `frontend/src/utils/activityDetection.js` - Core detection utilities
- `frontend/src/types/proctoring.ts` - Activity data type definitions

### Modified Files
- `frontend/src/components/proctoring/ProctoringPanel.jsx` - Integration with activity monitoring
- `frontend/src/hooks/useProctoringWebSocket.js` - Extended for activity data transmission
- `backend/ai_interviewer/models/proctoring.py` - Activity data models
- `backend/ai_interviewer/routers/proctoring.py` - Activity endpoints
- `backend/ai_interviewer/websocket/proctoring_manager.py` - Activity event handling
- `backend/ai_interviewer/services/proctoring_service.py` - Activity processing logic

### Configuration Files
- `frontend/src/config/proctoring.js` - Activity monitoring configuration
- `backend/ai_interviewer/config/proctoring.py` - Backend activity settings 